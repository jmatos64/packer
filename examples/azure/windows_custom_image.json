{
  "builders": [{
  "type": "azure-arm",
  "managed_image_name": "platform_agent_ami_{{isotime | clean_resource_name}}",

  "managed_image_resource_group_name": "agent-baking",
  "managed_image_storage_account_type": "Standard_LRS",

  "subscription_id": "7dbefeca-34df-4fd3-b8ed-0eedb80276f2",


  "build_resource_group_name": "agent-baking",
  "private_virtual_network_with_public_ip": true,
  "virtual_network_name": "agent-baking-vnet",

  "disk_caching_type": "None",

  "os_type": "Windows",
  "image_publisher": "MicrosoftWindowsServer",
  "image_offer": "WindowsServer",
  "image_sku": "2019-Datacenter",
  "image_version": "latest",

  "communicator": "winrm",
  "winrm_use_ssl": true,
  "winrm_insecure": true,
  "winrm_timeout": "10m",



  "azure_tags": {
    "description"       : "Windows2019image",
    "role"              : "agent",
    "created_by"        : "terraform",
    "github_repository" : "Polystream/Infrastructure-Cloud"
  },

  "vm_size": "Standard_DS3_v2"

}],
"provisioners": [
  {
    "type": "windows-restart",
    "restart_check_command": "powershell -command \"&amp; {Write-Output 'Machine restarted.'}\""
},
{
  "type":  "ansible",
  "playbook_file": "./windows_agent.yml",
  "extra_arguments": [
    "--connection", "packer",
    "--extra-vars", "ansible_shell_type=powershell ansible_shell_executable=None"
  ]
},
{
    "type": "windows-restart",
    "restart_check_command": "powershell -command \"&amp; {Write-Output 'Machine restarted.'}\""
},
{
  "type": "powershell",
  "inline": [
    "if( Test-Path $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml ){ rm $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml -Force}",
        "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit /mode:vm",
        "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
  ]
}]
}
